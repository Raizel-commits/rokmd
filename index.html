<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rok XD MiniBot • Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0b0d;
  --card:#141417;
  --border:#232327;
  --violet:#8b5cf6;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --highlight:#34d399;
  --glass-border: rgba(139,92,246,0.22);
}
*{box-sizing:border-box;}
body{margin:0;font-family:"JetBrains Mono", monospace;background:linear-gradient(180deg,#050506,#0b0b0d);color:var(--text);}
.header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--border);}
.menu-btn{font-size:22px;cursor:pointer;color:var(--violet);transition:.3s;}
.menu-btn:hover{transform:rotate(90deg);}
.side-menu{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#0b0b0d;border-right:1px solid var(--border);transition:.3s;z-index:1000;}
.side-menu.active{left:0;}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:900;}
.menu-overlay.active{display:flex;}
.side-header{padding:16px;border-bottom:1px solid var(--border);font-weight:bold;color:var(--violet);}
.side-links a{display:flex;align-items:center;gap:12px;padding:14px;color:#e5e7eb;text-decoration:none;transition:.3s;border-radius:8px;}
.side-links a:hover{background:rgba(139,92,246,0.15);color:var(--violet);}
.side-links a.active{background:rgba(139,92,246,0.22);}
.container{padding:20px;display:flex;justify-content:center;flex-wrap:wrap;gap:20px;}
.section{width:100%;max-width:900px;}
.card{max-width:420px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.6);text-align:center;transition:.3s;position:relative;backdrop-filter: blur(10px) saturate(140%);}
.card:hover{transform:translateY(-4px) scale(1.02);}
.avatar img{width:70px;height:70px;border-radius:50%;border:2px solid var(--violet);}
.btn{width:100%;margin-top:12px;padding:14px;background:var(--violet);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:.3s;}
.btn:hover{background:#7c3aed;transform:scale(1.05);}
.btn:disabled{opacity:.5;pointer-events:none;}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(20,20,23,0.95);border:1px solid var(--glass-border);padding:18px 26px;border-radius:16px;font-weight:bold;z-index:9999;color:var(--highlight);}
.bottom{position:fixed;bottom:0;left:0;right:0;background:#0b0b0d;border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:10px 0;}
.bottom a{text-decoration:none;color:var(--muted);}
.bottom a.active{color:var(--violet);}
input[type="tel"], input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(56,189,248,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));color:#eafff2;margin-bottom:12px;outline:none;font-size:14px;}
input::placeholder{color:rgba(200,255,255,0.22);}
.qrimg{width:240px;height:240px;margin:0 auto;display:block;background:#fff;padding:10px;border-radius:12px;}
.msg.success{margin-top:12px;padding:10px;border-radius:12px;background:rgba(52,211,153,0.1);border:1px solid var(--highlight);color:var(--highlight);display:flex;justify-content:space-between;align-items:center;}
.msg.success button{padding:6px 10px;border:none;background:var(--violet);color:#fff;border-radius:8px;cursor:pointer;}
.price-card{border:1px solid var(--border);border-radius:16px;padding:20px;transition:.3s;position:relative;background:#1a1a1d;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5);}
.price-card:hover{transform:translateY(-5px) scale(1.02);border-color:var(--violet);}
.price-card .title{font-size:20px;font-weight:600;color:var(--violet);margin-bottom:12px;}
.price-card .price{font-size:28px;font-weight:700;color:var(--highlight);margin-bottom:12px;}
.price-card ul{list-style:none;padding:0;margin:0 0 12px 0;text-align:left;}
.price-card ul li{padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.price-card .buy-btn{padding:12px 20px;font-weight:600;cursor:pointer;transition:.2s;}
.price-card .buy-btn:hover{background:rgba(139,92,246,0.22);color:#fff;transform:scale(1.05);}
.referral{display:flex;gap:8px;align-items:center;margin-top:10px;}
.referral input{flex:1;}
.referral button{width:auto;padding:8px 12px;}
.contact-wa{margin-top:12px;text-align:center;}
.contact-wa a{display:inline-block;margin:0 6px;padding:8px 12px;background:#25D366;color:#fff;border-radius:8px;text-decoration:none;font-weight:bold;}
</style>
</head>
<body>

<div class="header">
  <h1>Rok XD MiniBot</h1>
  <div class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
</div>

<div id="sideMenu" class="side-menu">
  <div class="side-header">ROK XD</div>
  <div class="side-links">
    <a href="#" onclick="showSection('bot')" class="active"><i class="fas fa-robot"></i> Bot</a>
    <a href="#" onclick="showSection('achat')"><i class="fas fa-shopping-cart"></i> Achat</a>
    <a href="#" onclick="showSection('coins')"><i class="fas fa-coins"></i> Coins</a>
    <a href="#" onclick="showSection('pair')"><i class="fas fa-link"></i> Pair</a>
    <a href="#" onclick="showSection('qr')"><i class="fas fa-qrcode"></i> QR</a>
    <a href="admin-login.html"><i class="fas fa-user-shield"></i> Admin</a>
    <a href="#" onclick="logout()"><i class="fas fa-power-off"></i> Logout</a>
  </div>
</div>
<div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

<div class="container">
  <!-- BOT -->
  <div id="section-bot" class="section">
    <div class="card">
      <div class="avatar"><img src="https://files.catbox.moe/36ywf8.jpeg" alt="Avatar Bot"></div>
      <h2>Bot Management</h2>
      <p id="botTimer">Bot inactif</p>
      <p>Coins : <b id="coins">0</b></p>
      <button id="watchAdBtn" class="btn"><i class="fas fa-video"></i> Watch Ad & Get 1 Coin</button>
    </div>
  </div>

  <!-- ACHAT -->
  <div id="section-achat" class="section" style="display:none;">
    <div class="price-card">
      <div class="title">24h Bot</div>
      <div class="price">200 XAF / 20 Coins</div>
      <ul>
        <li>Bot actif 24 heures</li>
        <li>Coins requis : 20</li>
      </ul>
      <button class="btn buy-btn" onclick="buyBotFCFA(24)">Acheter FCFA</button>
      <button class="btn buy-btn" onclick="buyBotCoins(24)">Acheter Coins</button>
    </div>
    <div class="price-card">
      <div class="title">48h Bot</div>
      <div class="price">350 XAF / 40 Coins</div>
      <ul>
        <li>Bot actif 48 heures</li>
        <li>Coins requis : 40</li>
      </ul>
      <button class="btn buy-btn" onclick="buyBotFCFA(48)">Acheter FCFA</button>
      <button class="btn buy-btn" onclick="buyBotCoins(48)">Acheter Coins</button>
    </div>
    <div class="price-card">
      <div class="title">72h Bot</div>
      <div class="price">500 XAF / 60 Coins</div>
      <ul>
        <li>Bot actif 72 heures</li>
        <li>Coins requis : 60</li>
      </ul>
      <button class="btn buy-btn" onclick="buyBotFCFA(72)">Acheter FCFA</button>
      <button class="btn buy-btn" onclick="buyBotCoins(72)">Acheter Coins</button>
    </div>
  </div>

  <!-- COINS -->
  <div id="section-coins" class="section" style="display:none;">
    <div class="card">
      <h2>Coins</h2>
      <p>Obtenez des coins gratuits :</p>
      <ul style="text-align:left;">
        <li>Regardez 2 pubs par jour (+1 coin par pub)</li>
        <li>Parrainage : partagez votre lien pour gagner des coins</li>
      </ul>
      <div class="referral">
        <input id="referralLink" type="text" readonly>
        <button onclick="copyReferral()" class="btn">Copier</button>
      </div>
      <div class="contact-wa">
        <p>Contact WhatsApp :</p>
        <a href="https://wa.me/237699777530" target="_blank">+237 699 777 530</a>
        <a href="https://wa.me/237673941535" target="_blank">+237 673 941 535</a>
      </div>
    </div>
  </div>

  <!-- PAIR -->
  <div id="section-pair" class="section" style="display:none;">
    <div class="card">
      <h2>Pairing & Config</h2>
      <input id="phonePair" type="tel" placeholder="2376XXXXXXX">
      <button id="pairBtn2" class="btn">Générer le code</button>
      <div id="pairResult"></div>
      <input id="prefix" type="text" placeholder="Préfixe commandes (ex: !)">
      <button id="configBtn" class="btn">Sauvegarder Config</button>
      <div id="configResult"></div>
    </div>
  </div>

  <!-- QR -->
  <div id="section-qr" class="section" style="display:none;">
    <div class="card">
      <h2>QR Code</h2>
      <input id="phoneQR" type="tel" placeholder="2376XXXXXXX">
      <button id="btnQR" class="btn">Générer QR</button>
      <div id="resultQR"></div>
    </div>
  </div>

</div>

<div class="bottom">
  <a href="#" onclick="showSection('bot')" class="active">Bot</a>
  <a href="#" onclick="showSection('achat')">Achat</a>
  <a href="#" onclick="showSection('coins')">Coins</a>
  <a href="admin-login.html"><i class="fas fa-user-shield"></i> Admin</a>
</div>

<script>
// ====== VARIABLES ======
let botTimeRemaining = 0, userCoins = 0, timerInterval;
let currentPairCode = '';
const coinsEl = document.getElementById('coins');
const botTimer = document.getElementById('botTimer');
const watchAdBtn = document.getElementById('watchAdBtn');
const sideMenu = document.getElementById('sideMenu');
const menuOverlay = document.getElementById('menuOverlay');
const referralInput = document.getElementById('referralLink');

// ====== MENU & SECTIONS ======
function toggleMenu() { sideMenu.classList.toggle('active'); menuOverlay.classList.toggle('active'); }
function showSection(name){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  const sec = document.getElementById('section-'+name);
  if(sec) sec.style.display='block';
  document.querySelectorAll('.side-links a, .bottom a').forEach(a=>{
    a.classList.remove('active');
    if(a.textContent.trim().toLowerCase() === name) a.classList.add('active');
  });
}

// ====== LOGOUT ======
function logout(){ fetch('/logout',{method:'POST'}).then(()=>location.href='/login').catch(()=>location.href='/login'); }

// ====== TOAST ======
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2500); }

// ====== BOT TIMER & ACCESS ======
function updateBotAccessUI(){
  const isActive = botTimeRemaining > 0;
  ["section-pair","section-qr"].forEach(id=>{
    const sec = document.getElementById(id); if(!sec) return;
    sec.style.opacity = isActive ? "1" : "0.45";
    sec.querySelectorAll("input,button").forEach(el=>el.disabled = !isActive);
  });
}

function updateTimer(){
  if(timerInterval) clearInterval(timerInterval);
  if(botTimeRemaining <= 0){ botTimer.textContent="Bot inactif"; updateBotAccessUI(); return; }
  timerInterval=setInterval(()=>{
    if(botTimeRemaining <= 0){ clearInterval(timerInterval); updateTimer(); return; }
    const h=Math.floor(botTimeRemaining/3600000);
    const m=Math.floor((botTimeRemaining%3600000)/60000);
    const s=Math.floor((botTimeRemaining%60000)/1000);
    botTimer.textContent=`Actif : ${h}h ${m}m ${s}s`;
    botTimeRemaining-=1000;
    updateBotAccessUI();
  },1000);
}

// ====== LOAD STATUS ======
async function loadStatus(){
  try{
    const r=await fetch('/coins'); const d=await r.json();
    if(d.error){ location.href='/login'; return; }
    userCoins=d.coins||0; 
    botTimeRemaining=d.botRemaining||0; // ✅ correction ici
    coinsEl.textContent=userCoins;
    referralInput.value=`${location.origin}/?ref=${d.username}`; // ✅ username inclus
    updateTimer(); updateBotAccessUI();
  }catch(e){ console.error(e); toast("Erreur de chargement"); }
}
// WATCH ADS
let adCount=0;
watchAdBtn.onclick=()=>{
  if(adCount>=2){toast("Limite quotidienne atteinte"); return;}
  adModal.style.display="flex"; adVideo.play();
  adVideo.onended=async()=>{
    adModal.style.display="none"; adCount++;
    const res=await fetch('/watch-ad/complete',{method:'POST'});
    const data=await res.json();
    if(data.success){ userCoins=data.coins; coinsEl.textContent=userCoins; toast("+1 coin ajouté !"); }
  }
};

// COPY REFERRAL
function copyReferral(){
  referralInput.select(); referralInput.setSelectionRange(0,99999);
  navigator.clipboard.writeText(referralInput.value);
  toast("Lien copié !");
}

// BUY BOT COINS / FCFA
const priceFcfaBot={24:500,48:1000,72:1500};
const priceCoinsBot={24:20,48:40,72:60};

async function buyBotCoins(hours){
  if(userCoins < priceCoinsBot[hours]){ toast("Coins insuffisants"); return; }
  const res=await fetch('/pay',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'bot',option:hours+'h'})});
  const data=await res.json();
  if(data.error){ toast(data.error); return; }
  toast(`Bot acheté ${hours}h avec ${priceCoinsBot[hours]} coins !`);
  userCoins -= priceCoinsBot[hours]; coinsEl.textContent=userCoins;
  botTimeRemaining += hours*3600*1000;
  updateTimer();
}

function buyBotFCFA(hours){
  const paymentId="moneyfusion_"+Date.now();
  const amount=priceFcfaBot[hours];
  const url=`https://payin.moneyfusion.net/payment/69620e03013a0771970d2b80/${amount}/${paymentId}`;
  window.location.href=url;
}

// BOT ACCESS CHECK
function checkBotAccess(){
  const blocked = botTimeRemaining<=0;
  ['section-pair','section-qr'].forEach(id=>{
    const sec=document.getElementById(id);
    sec.querySelectorAll('input, button').forEach(el=>el.disabled=blocked);
    sec.style.opacity = blocked ? 0.5 : 1;
  });
}

// PAIR CODE
const pairBtn2=document.getElementById("pairBtn2");
const pairResult=document.getElementById("pairResult");
pairBtn2.onclick=async()=>{
  const phone=document.getElementById("phonePair").value.trim();
  if(!phone){ pairResult.innerHTML='<span style="color:#ef4444;">Numéro requis</span>'; return;}
  pairBtn2.disabled=true; pairResult.innerHTML='<span style="color:#8b5cf6;">Génération en cours...</span>';
  try{ const r=await fetch(`/pair-api/code?number=${encodeURIComponent(phone)}`); const d=await r.json();
    if(d.code){ currentPairCode=d.code; pairResult.innerHTML=`<span style="color:#34d399;">Code : ${d.code}</span>`; } else pairResult.innerHTML=`<span style="color:#ef4444;">Erreur : ${d.error||d.status}</span>`;}
  catch(e){ pairResult.innerHTML='<span style="color:#ef4444;">Erreur serveur</span>'; console.error(e);}
  pairBtn2.disabled=false;
};
function copyPairCode(){
  if(!currentPairCode){ toast("Aucun code à copier"); return;}
  navigator.clipboard.writeText(currentPairCode);
  toast("Code Pair copié !");
}

// CONFIG
const configBtn=document.getElementById("configBtn");
const configResult=document.getElementById("configResult");
configBtn.onclick=async()=>{
  const number=document.getElementById("phonePair").value.trim();
  const prefix=document.getElementById("prefix").value.trim()||"!";
  if(!number){ configResult.innerHTML='<span style="color:#ef4444;">Numéro requis</span>'; return;}
  configBtn.disabled=true; configResult.innerHTML='<span style="color:#8b5cf6;">Sauvegarde en cours...</span>';
  try{ const r=await fetch("/pair-api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({number,prefix})}); const d=await r.json();
    configResult.innerHTML=d.status?`<span style="color:#34d399;">${d.status}</span>`:`<span style="color:#ef4444;">${d.error}</span>`;}
  catch(e){ configResult.innerHTML='<span style="color:#ef4444;">Erreur serveur</span>'; console.error(e);}
  configBtn.disabled=false;
};

// QR CODE
const btnQR=document.getElementById("btnQR");
const resultQR=document.getElementById("resultQR");
btnQR.onclick=async()=>{
  const phone=document.getElementById("phoneQR").value.trim();
  if(!phone){ resultQR.innerHTML='<span style="color:#ef4444;">Numéro requis</span>'; return;}
  btnQR.disabled=true; resultQR.innerHTML='<span style="color:#8b5cf6;">Génération en cours...</span>';
  try{ const r=await fetch(`/qr?number=${encodeURIComponent(phone)}`); const d=await r.json();
    if(d.qr){ resultQR.innerHTML=`<img src="${d.qr}" class="qrimg"><div>${phone}</div>`; } else resultQR.innerHTML=`<span style="color:#ef4444;">Erreur : ${d.error}</span>`;}
  catch(e){ resultQR.innerHTML='<span style="color:#ef4444;">Erreur serveur</span>'; console.error(e);}
  btnQR.disabled=false;
};

loadStatus();
</script>
</body>
</html>
