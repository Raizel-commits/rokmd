<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROK XD • Pairing & Config</title>
<style>
:root{--bg-1:#020617;--bg-2:#0f172a;--neon:#38bdf8;--glass-border:rgba(56,189,248,0.22);}
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#dfffe6;}
header{padding:15px;background:#020617;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:18px;color:var(--neon);}
button.logout{background:#ef4444;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
main{display:flex;flex-direction:column;align-items:center;padding:20px;}
.glass-card{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;width:90%;max-width:400px;text-align:center;}
input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;font-size:14px;}
button{background:var(--neon);color:#020617;font-weight:bold;cursor:pointer;}
button:hover{opacity:0.9;}
.result{margin-top:12px;font-weight:bold;}
.dots::after{content:'';animation:blink 1s infinite;}
@keyframes blink{0%,20%{content:'';}40%{content:'.';}60%{content:'..';}80%,100%{content:'...';}}
</style>
</head>
<body>
<header>
  <h1>ROK XD • Pairing</h1>
  <button class="logout" id="logoutBtn">Déconnexion</button>
</header>
<main>
<section class="glass-card">
  <h2>Pairing WhatsApp</h2>
  <input id="phone" type="tel" placeholder="2376XXXXXXX">
  <button id="pairBtn">Générer le code</button>
  <div class="result" id="pairResult"></div>
  <hr>
  <input id="prefix" type="text" placeholder="Préfixe commandes (!)">
  <button id="configBtn">Sauvegarder Config</button>
  <div class="result" id="configResult"></div>
</section>
</main>

<script>
const sessionId = localStorage.getItem("sessionId");
if(!sessionId) window.location.href="/";

// Déconnexion
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("sessionId");
  window.location.href="/";
};

// PAIRING
const pairBtn = document.getElementById("pairBtn");
const pairResult = document.getElementById("pairResult");
pairBtn.onclick = async ()=>{
  const phone = document.getElementById("phone").value.trim();
  if(!phone){ pairResult.innerHTML='<span style="color:#ef4444;">Numéro requis</span>'; return; }
  pairBtn.disabled=true;
  pairResult.innerHTML='<span style="color:#38bdf8;">Génération en cours<span class="dots"></span></span>';

  try{
    const r = await fetch(`/code?number=${encodeURIComponent(phone)}`, {
      headers: {"x-session-id": sessionId}
    });
    const data = await r.json();
    if(data.code) pairResult.innerHTML='<span style="color:#38bdf8;">Code généré : '+data.code+'</span>';
    else if(data.status) pairResult.innerHTML='<span style="color:#38bdf8;">'+data.status+'</span>';
    else if(data.error) pairResult.innerHTML='<span style="color:#ef4444;">Erreur : '+data.error+'</span>';
  }catch(e){ pairResult.innerHTML='<span style="color:#ef4444;">Erreur serveur</span>'; console.error(e);}
  pairBtn.disabled=false;
};

// CONFIG
const configBtn = document.getElementById("configBtn");
const configResult = document.getElementById("configResult");
configBtn.onclick = async ()=>{
  const number = document.getElementById("phone").value.trim();
  const prefix = document.getElementById("prefix").value.trim() || "!";

  if(!number){ configResult.innerHTML='<span style="color:#ef4444;">Numéro requis</span>'; return; }

  configBtn.disabled=true;
  configResult.innerHTML='<span style="color:#38bdf8;">Sauvegarde en cours<span class="dots"></span></span>';

  try{
    const r = await fetch("/config", {
      method:"POST",
      headers:{"Content-Type":"application/json","x-session-id": sessionId},
      body: JSON.stringify({number,prefix})
    });
    const data = await r.json();
    if(data.status) configResult.innerHTML='<span style="color:#38bdf8;">'+data.status+'</span>';
    else if(data.error) configResult.innerHTML='<span style="color:#ef4444;">Erreur : '+data.error+'</span>';
  }catch(e){ configResult.innerHTML='<span style="color:#ef4444;">Erreur serveur</span>'; console.error(e);}
  configBtn.disabled=false;
};
</script>
</body>
</html>
